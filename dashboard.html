<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω Kho - T·ªïng Quan</title>
    <link rel="stylesheet" href="assets/style.css">
    <script src="assets/script.js" defer></script>
    <!-- Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body data-page="dashboard">
    <div class="container">
        <div class="header">
            <h1>üè™ H·ªá Th·ªëng Qu·∫£n L√Ω Kho</h1>
            <p>T·ªïng quan & B√°o c√°o</p>
        </div>

        <nav class="nav-menu">
            <a href="index.html" class="nav-item" data-page="home">
                üè† Trang Ch·ªß
            </a>
            <a href="nhaphang.html" class="nav-item" data-page="nhaphang">
                üì¶ Nh·∫≠p H√†ng
            </a>
            <a href="banhang.html" class="nav-item" data-page="banhang">
                üõí B√°n H√†ng
            </a>
            <a href="dashboard.html" class="nav-item active" data-page="dashboard">
                üìä T·ªïng Quan
            </a>
        </nav>

        <div class="main-content">
            <div class="connection-status">
                <span class="status-indicator status-disconnected" id="statusIndicator"></span>
                <span id="connectionText">ƒêang ki·ªÉm tra k·∫øt n·ªëi...</span>
                <br>
                <button onclick="window.testConnection()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    üîç Test K·∫øt N·ªëi
                </button>
            </div>

            <div class="alert alert-success" id="successAlert"></div>
            <div class="alert alert-error" id="errorAlert"></div>
            <div class="alert alert-info" id="infoAlert"></div>

            <!-- Filter Section -->
            <div class="filter-section">
                <h4>üìÖ B·ªô L·ªçc Th·ªùi Gian</h4>
                <div class="filter-controls">
                    <select id="timeRange" class="form-control" style="width: auto;" onchange="loadDashboardData()">
                        <option value="today">H√¥m nay</option>
                        <option value="last7days">7 ng√†y qua</option>
                        <option value="last30days">30 ng√†y qua</option>
                        <option value="thisMonth">Th√°ng n√†y</option>
                        <option value="all" selected>T·∫•t c·∫£ th·ªùi gian</option>
                    </select>
                    <button class="btn btn-info" onclick="loadDashboardData()" style="width: auto;">
                        üîÑ L√†m M·ªõi
                    </button>
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="dashboard-grid">
                <div class="kpi-card">
                    <h3>üì¶ T·ªïng Nh·∫≠p</h3>
                    <div class="number" id="totalImports">0</div>
                    <div class="trend" id="importsTrend">+0% so v·ªõi k·ª≥ tr∆∞·ªõc</div>
                </div>

                <div class="kpi-card">
                    <h3>üõí T·ªïng B√°n</h3>
                    <div class="number" id="totalSales">0</div>
                    <div class="trend" id="salesTrend">+0% so v·ªõi k·ª≥ tr∆∞·ªõc</div>
                </div>

                <div class="kpi-card">
                    <h3>üìä T·ªìn Kho</h3>
                    <div class="number" id="totalStock">0</div>
                    <div class="trend" id="stockTrend">S·∫£n ph·∫©m trong kho</div>
                </div>

                <div class="kpi-card">
                    <h3>üí∞ Doanh Thu</h3>
                    <div class="number" id="totalRevenue">0‚Ç´</div>
                    <div class="trend" id="revenueTrend">+0% so v·ªõi k·ª≥ tr∆∞·ªõc</div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <!-- Top Products Chart -->
                <div class="chart-container">
                    <h3>üèÜ Top 5 S·∫£n Ph·∫©m B√°n Ch·∫°y</h3>
                    <canvas id="topProductsChart" width="400" height="300"></canvas>
                </div>

                <!-- Sales Trend Chart -->
                <div class="chart-container">
                    <h3>üìà Xu H∆∞·ªõng B√°n H√†ng</h3>
                    <canvas id="salesTrendChart" width="400" height="300"></canvas>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <!-- Stock Distribution Chart -->
                <div class="chart-container">
                    <h3>üìä Ph√¢n B·ªë T·ªìn Kho</h3>
                    <canvas id="stockDistributionChart" width="400" height="300"></canvas>
                </div>

                <!-- Import vs Sales Chart -->
                <div class="chart-container">
                    <h3>‚öñÔ∏è So S√°nh Nh·∫≠p vs B√°n</h3>
                    <canvas id="importVsSalesChart" width="400" height="300"></canvas>
                </div>
            </div>

            <!-- Detailed Tables -->
            <div class="chart-container">
                <h3>üìã B·∫£ng T·ªïng H·ª£p S·∫£n Ph·∫©m</h3>
                <div id="productSummaryTable" style="text-align: center; padding: 20px; color: #7f8c8d;">
                    <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="chart-container">
                <h3>üïí Ho·∫°t ƒê·ªông G·∫ßn ƒê√¢y</h3>
                <div id="recentActivity" style="text-align: center; padding: 20px; color: #7f8c8d;">
                    <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let charts = {};

        // Kh·ªüi t·∫°o dashboard
        async function initializeDashboard() {
            console.log('Kh·ªüi t·∫°o dashboard...');
            
            // Test k·∫øt n·ªëi
            await testConnection();
            
            // Load d·ªØ li·ªáu ban ƒë·∫ßu
            await loadDashboardData();
        }

        // Load d·ªØ li·ªáu dashboard
        async function loadDashboardData() {
            try {
                showLoading(true);
                const timeRange = document.getElementById('timeRange').value;
                
                console.log('Loading dashboard data for range:', timeRange);
                
                // T·∫°m th·ªùi s·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u cho demo
                const mockData = generateMockData(timeRange);
                
                updateKPICards(mockData.kpi);
                updateCharts(mockData.charts);
                updateTables(mockData.tables);
                updateRecentActivity(mockData.recentActivity);
                
            } catch (error) {
                console.error('L·ªói khi t·∫£i d·ªØ li·ªáu dashboard:', error);
                showError('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu dashboard');
            } finally {
                showLoading(false);
            }
        }

        // T·∫°o d·ªØ li·ªáu m·∫´u cho demo
        function generateMockData(timeRange) {
            const baseData = {
                totalImports: Math.floor(Math.random() * 1000) + 500,
                totalSales: Math.floor(Math.random() * 800) + 300,
                totalStock: Math.floor(Math.random() * 500) + 200,
                totalRevenue: Math.floor(Math.random() * 50000000) + 20000000
            };

            return {
                kpi: {
                    totalImports: baseData.totalImports,
                    totalSales: baseData.totalSales,
                    totalStock: baseData.totalStock,
                    totalRevenue: baseData.totalRevenue,
                    importsTrend: '+12%',
                    salesTrend: '+8%',
                    stockTrend: 'S·∫£n ph·∫©m trong kho',
                    revenueTrend: '+15%'
                },
                charts: {
                    topProducts: [
                        { name: 'M√ÄI DAO', sales: 150 },
                        { name: 'V√íI PHUN S∆Ø∆†NG', sales: 120 },
                        { name: 'K·∫∏P INOX', sales: 100 },
                        { name: 'B·∫™Y CHU·ªòT', sales: 80 },
                        { name: 'T·∫§M CH·∫ÆN N·∫ÆNG', sales: 60 }
                    ],
                    salesTrend: [
                        { date: '01/08', sales: 45 },
                        { date: '02/08', sales: 52 },
                        { date: '03/08', sales: 38 },
                        { date: '04/08', sales: 61 },
                        { date: '05/08', sales: 48 },
                        { date: '06/08', sales: 55 }
                    ],
                    stockDistribution: [
                        { name: 'M√ÄI DAO', stock: 200 },
                        { name: 'V√íI PHUN S∆Ø∆†NG', stock: 150 },
                        { name: 'K·∫∏P INOX', stock: 120 },
                        { name: 'B·∫™Y CHU·ªòT', stock: 80 },
                        { name: 'KH√ÅC', stock: 300 }
                    ]
                },
                tables: {
                    products: [
                        { name: 'M√ÄI DAO', imports: 300, sales: 150, stock: 200, revenue: 15000000 },
                        { name: 'V√íI PHUN S∆Ø∆†NG', imports: 250, sales: 120, stock: 150, revenue: 12000000 },
                        { name: 'K·∫∏P INOX', imports: 200, sales: 100, stock: 120, revenue: 10000000 },
                        { name: 'B·∫™Y CHU·ªòT', imports: 150, sales: 80, stock: 80, revenue: 8000000 },
                        { name: 'T·∫§M CH·∫ÆN N·∫ÆNG', imports: 100, sales: 60, stock: 50, revenue: 6000000 }
                    ]
                },
                recentActivity: [
                    { time: '14:30', action: 'B√°n h√†ng', product: 'M√ÄI DAO', barcode: 'MD-01-015' },
                    { time: '14:25', action: 'Nh·∫≠p h√†ng', product: 'V√íI PHUN S∆Ø∆†NG', quantity: 50 },
                    { time: '14:20', action: 'B√°n h√†ng', product: 'K·∫∏P INOX', barcode: 'KI-01-008' },
                    { time: '14:15', action: 'Nh·∫≠p h√†ng', product: 'B·∫™Y CHU·ªòT', quantity: 30 },
                    { time: '14:10', action: 'B√°n h√†ng', product: 'T·∫§M CH·∫ÆN N·∫ÆNG', barcode: 'TCN-01-003' }
                ]
            };
        }

        // C·∫≠p nh·∫≠t KPI cards
        function updateKPICards(kpiData) {
            document.getElementById('totalImports').textContent = kpiData.totalImports.toLocaleString();
            document.getElementById('totalSales').textContent = kpiData.totalSales.toLocaleString();
            document.getElementById('totalStock').textContent = kpiData.totalStock.toLocaleString();
            document.getElementById('totalRevenue').textContent = formatCurrency(kpiData.totalRevenue);
            
            document.getElementById('importsTrend').textContent = kpiData.importsTrend;
            document.getElementById('salesTrend').textContent = kpiData.salesTrend;
            document.getElementById('stockTrend').textContent = kpiData.stockTrend;
            document.getElementById('revenueTrend').textContent = kpiData.revenueTrend;
        }

        // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì
        function updateCharts(chartData) {
            // Top Products Chart
            updateTopProductsChart(chartData.topProducts);
            
            // Sales Trend Chart
            updateSalesTrendChart(chartData.salesTrend);
            
            // Stock Distribution Chart
            updateStockDistributionChart(chartData.stockDistribution);
            
            // Import vs Sales Chart
            updateImportVsSalesChart(chartData.topProducts);
        }

        // Bi·ªÉu ƒë·ªì top s·∫£n ph·∫©m
        function updateTopProductsChart(data) {
            const ctx = document.getElementById('topProductsChart').getContext('2d');
            
            if (charts.topProducts) {
                charts.topProducts.destroy();
            }
            
            charts.topProducts = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item.name),
                    datasets: [{
                        label: 'S·ªë l∆∞·ª£ng b√°n',
                        data: data.map(item => item.sales),
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Bi·ªÉu ƒë·ªì xu h∆∞·ªõng b√°n h√†ng
        function updateSalesTrendChart(data) {
            const ctx = document.getElementById('salesTrendChart').getContext('2d');
            
            if (charts.salesTrend) {
                charts.salesTrend.destroy();
            }
            
            charts.salesTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => item.date),
                    datasets: [{
                        label: 'S·ªë l∆∞·ª£ng b√°n',
                        data: data.map(item => item.sales),
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Bi·ªÉu ƒë·ªì ph√¢n b·ªë t·ªìn kho
        function updateStockDistributionChart(data) {
            const ctx = document.getElementById('stockDistributionChart').getContext('2d');
            
            if (charts.stockDistribution) {
                charts.stockDistribution.destroy();
            }
            
            charts.stockDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(item => item.name),
                    datasets: [{
                        data: data.map(item => item.stock),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 205, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Bi·ªÉu ƒë·ªì so s√°nh nh·∫≠p vs b√°n
        function updateImportVsSalesChart(data) {
            const ctx = document.getElementById('importVsSalesChart').getContext('2d');
            
            if (charts.importVsSales) {
                charts.importVsSales.destroy();
            }
            
            charts.importVsSales = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item.name),
                    datasets: [{
                        label: 'Nh·∫≠p h√†ng',
                        data: data.map(item => item.sales * 2), // Gi·∫£ s·ª≠ nh·∫≠p g·∫•p ƒë√¥i b√°n
                        backgroundColor: 'rgba(255, 99, 132, 0.8)'
                    }, {
                        label: 'B√°n h√†ng',
                        data: data.map(item => item.sales),
                        backgroundColor: 'rgba(54, 162, 235, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // C·∫≠p nh·∫≠t b·∫£ng t·ªïng h·ª£p
        function updateTables(tableData) {
            const container = document.getElementById('productSummaryTable');
            
            const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>S·∫£n Ph·∫©m</th>
                            <th>ƒê√£ Nh·∫≠p</th>
                            <th>ƒê√£ B√°n</th>
                            <th>T·ªìn Kho</th>
                            <th>Doanh Thu</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableData.products.map(product => `
                            <tr>
                                <td><strong>${product.name}</strong></td>
                                <td>${product.imports.toLocaleString()}</td>
                                <td>${product.sales.toLocaleString()}</td>
                                <td>${product.stock.toLocaleString()}</td>
                                <td>${formatCurrency(product.revenue)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }

        // C·∫≠p nh·∫≠t ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y
        function updateRecentActivity(activities) {
            const container = document.getElementById('recentActivity');
            
            const activityList = `
                <div style="text-align: left;">
                    ${activities.map(activity => `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${activity.time}</strong> - ${activity.action}: ${activity.product}
                                ${activity.barcode ? ` (${activity.barcode})` : ''}
                                ${activity.quantity ? ` - ${activity.quantity} th√πng` : ''}
                            </div>
                            <span style="color: ${activity.action === 'B√°n h√†ng' ? '#e74c3c' : '#27ae60'}; font-weight: bold;">
                                ${activity.action === 'B√°n h√†ng' ? 'üõí' : 'üì¶'}
                            </span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = activityList;
        }

        // Kh·ªüi t·∫°o trang
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Trang dashboard ƒë√£ load');
            initializeDashboard();
        });
    </script>
</body>
</html> 